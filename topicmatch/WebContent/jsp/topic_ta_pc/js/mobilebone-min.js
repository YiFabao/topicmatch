/*
 * mobilebone.js
 * by zhangxinxu(.com) 2014-09-26
 * https://github.com/zhangxinxu/mobilebone
 * bone of switch for mobile web app 
**/
!function(a,b){"function"==typeof define&&(define.amd||define.cmd)?define("mobilebone",function(c){return b(a,c)}):a.Mobilebone=b(a,{})}(this,function(a,b){var h,i,c={},d=[],e=d.slice,f=/^.[^:#\[\.,]*$/,g="pushState"in history&&"replaceState"in history;return b.support=g,0==g?b:(h=!1,b.VERSION="2.2.0",b.captureLink=!0,b.captureForm=!0,b.rootTransition=a,b.mergeCallback=!0,b.classAnimation="slide",b.classPage="page",b.classMask="mask",b.pushStateEnabled=!0,window.navigator.userAgent.indexOf("Firefox")>=0&&window.top!==window&&(b.pushStateEnabled=!1),b.transition=function(a,d,f,h){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;if(0!=arguments.length&&a!=d){if(3==arguments.length&&1==isNaN(1*f)&&(h=f,f=!1),d=d||null,f=f||!1,h=h||{},j={root:this.rootTransition,form:this.form||this.classAnimation,onpagefirstinto:this.onpagefirstinto,animationstart:this.animationstart,animationend:this.animationend,fallback:this.fallback,callback:this.callback},k=function(a){if(!a||!a.getAttribute)return{};var c={},d=i(a.getAttribute("data-params")||"");return["title","root","form"].forEach(function(b){c[b]=a.getAttribute("data-"+b)||d[b]||h[b]||j[b]}),"string"==typeof c.root&&(c.root=b.getFunction(c.root)),["onpagefirstinto","callback","fallback","animationstart","animationend","preventdefault"].forEach(function(e){if(1==b.mergeCallback&&"function"==typeof j[e]){var f=a.getAttribute("data-"+e)||d[e];c[e]="function"==typeof c.root[f]?function(){j[e].apply(this,arguments),c.root[f].apply(this,arguments)}:"function"==typeof h[e]?function(){j[e].apply(this,arguments),h[e].apply(this,arguments)}:j[e]}else c[e]=a.getAttribute("data-"+e)||d[e]||h[e]||j[e]}),c},l=k(d),m=k(a),null!=d&&d.classList&&(n=l.preventdefault,o=!1,"string"==typeof n&&(n=l.root[n]),"function"==typeof n&&(o=n.call(l.root,a,d,h))),null!=a&&a.classList&&(p=m.preventdefault,q=!1,"string"==typeof p&&(p=m.root[p]),"function"==typeof p&&(q=p.call(m.root,a,d,h)),1==q))return this;null!=d&&d.classList&&1!=o&&(d.classList.add("out"),d.classList.add(l.form),d.classList.remove("in"),d.classList[f?"add":"remove"]("reverse"),r=l.fallback,"string"==typeof r&&(r=l.root[r]),"function"==typeof r&&r.call(l.root,a,d,h)),null!=a&&a.classList&&(s=m.title,t=document.querySelector("h1"),u=document.querySelector("."+this.classPage),s?(document.title=s,t&&(t.innerHTML=s,t.title=s)):u==a&&!d&&document.title&&a.setAttribute("data-title",document.title),v=h.id||a.id,h.remove!==!1&&c[v]&&c[v]!=a&&c[v].parentElement&&(c[v].parentElement.removeChild(c[v]),delete c[v]),a.style.display="block",a.clientWidth,a.classList.remove("out"),a.classList.add("in"),d&&a.classList.add(m.form),a.classList[f?"add":"remove"]("reverse"),w=m.onpagefirstinto,c[v]||("string"==typeof w&&m.root[w]?m.root[w](a,d,h):"function"==typeof w&&w(a,d,h),e.call(a.querySelectorAll("form")).forEach(function(a){b.submit(a)})),x="WebkitAppearance"in document.documentElement.style||"undefined"!=typeof document.webkitHidden,["animationstart","animationend"].forEach(function(b,d){var g,e=m[b],f="webkit"+b.replace(/^a|s|e/g,function(a){return a.toUpperCase()});c[v]||(g=x?f:b,d&&a.addEventListener(g,function(){0==this.classList.contains("in")&&(this.style.display="none")}),"string"==typeof e&&m.root[e]?a.addEventListener(g,function(){m.root[e](this,this.classList.contains("in")?"into":"out",h)}):"function"==typeof e&&a.addEventListener(g,function(){e(this,this.classList.contains("in")?"into":"out",h)}))}),y=v,y&&0==/^#/.test(y)&&(y="#"+y),g&&this.pushStateEnabled&&h.history!==!1&&y&&history[d?"pushState":"replaceState"](null,document.title,y.replace(/^#/,"#&")),c[v]||(c[v]=a),z=m.callback,"string"==typeof z&&(z=m.root[z]),"function"==typeof z&&z.call(m.root,a,d,h))}},b.getCleanUrl=function(a,b,c){var g,d="",e="",f="";if(a)if(1==a.nodeType){if(a.action)return a.getAttribute("action");d=a.getAttribute("href"),e=a.getAttribute("data-formdata")||a.getAttribute("data-data")}else a.url&&(d=a.url,e=a.data);if(!(d=d||b))return"";if(e=e||c||"","object"==typeof e){g=[];for(key in c)g.push(key+"="+encodeURIComponent(c[key]));e=g.length>0?g.join("&"):""}return f=d.split("#")[0].replace(/&+$/,""),"?"==f.slice(-1)&&(f=f.split("?")[0]),""!=e&&(/\?/.test(f)?(e=e.replace(/^&|\?/,""),f=f+"&"+e):""!=e&&(e=e.replace("?",""),f=f+"?"+e)),f},b.createPage=function(a,b,c){var e,f,g,h,i,j,d=null;a&&(c=c||{},e=document.querySelector(".in."+this.classPage),b&&(1==b.nodeType?((b.href||b.action)&&(f=b.getAttribute("data-title")||c.title),d=c.response):(d=b.response||c.response,f=b.title||c.title)),g=null,h=document.createElement("div"),"string"==typeof a?h.innerHTML=a:h.appendChild(a),i=h.getElementsByTagName("title")[0],(g=h.querySelector("."+this.classPage))?i?g.setAttribute("data-title",i.innerText):"string"==typeof f&&g.setAttribute("data-title",f):(h.className="page out","string"==typeof f&&h.setAttribute("data-title",f),g=h),document.body.appendChild(g),h=null,j={response:d||a,id:this.getCleanUrl(b)||g.id||"unique"+Date.now()},"object"==typeof c&&("undefined"!=typeof c.history&&(j.history=c.history),"undefined"!=typeof c.remove&&(j.remove=c.remove),"undefined"!=typeof c.target&&(j.target=c.target)),this.transition(g,e,j))},b.getFunction=function(b){var c,d,e;if("string"==typeof b){for(c=a,d=b.split("."),e=0;e<d.length&&(c=c[d[e]]);e+=1);return c}},b.ajax=function(a){var c,d,e,f,h,g,j,k;if(a){if(c={url:"",type:"",dataType:"",data:{},timeout:1e4,async:!0,username:"",password:"",success:function(){},error:function(){},complete:function(){}},d={},e=null,f=null,g={},1==a.nodeType){g=i(a.getAttribute("data-params")||"");for(key in c)d[key]=a.getAttribute("data-"+key)||g[key]||c[key],"function"==typeof c[key]&&"string"==typeof d[key]&&(d[key]=this.getFunction(d[key]),"function"!=typeof d[key]&&(d[key]=c[key]));d.url=this.getCleanUrl(a,d.url),d.target=a,j=a.tagName.toLowerCase(),"form"==j&&(d.type=a.method,f=new FormData(a)),h=a.getAttribute("data-mask"),("true"==h||""==h)&&(e=a.querySelector("."+this.classMask))}else{if(!a.url)return;for(key2 in c)d[key2]=a[key2]||c[key2];d.url=this.getCleanUrl(null,d.url,d.data),d.title=a.title}"string"!=typeof h&&(e=document.querySelector("body > ."+this.classMask)),null==e&&(e=document.createElement("div"),e.className=this.classMask,e.innerHTML='<i class="loading"></i>',"string"==typeof h?a.appendChild(e):document.body.appendChild(e)),e.style.visibility="visible",k=new XMLHttpRequest,k.open(d.type||"GET",d.url+(/\?/.test(d.url)?"&":"?")+"r="+Date.now(),d.async,d.username,d.password),k.timeout=d.timeout,k.onload=function(){var c=null;if(200==k.status){if("json"==d.dataType||"JSON"==d.dataType)try{c=JSON.parse(k.response),d.response=c,b.createPage(b.jsonHandle(c),a,d)}catch(f){d.message="JSON parse errorï¼š"+f.message,d.error.call(d,k,k.status)}else if("unknown"==d.dataType){d.history=!1,d.remove=!1;try{c=JSON.parse(k.response),d.response=c,b.createPage(b.jsonHandle(c),a,d)}catch(f){c=k.response,b.createPage(c,a,d)}}else c=k.response,b.createPage(c,a,d);d.success.call(d,c,k.status)}else d.message="The status code exception!",d.error.call(d,k,k.status);d.complete.call(d,k,k.status),e.style.visibility="hidden"},k.onerror=function(){d.message="Illegal request address or an unexpected network error!",d.error.call(d,k,k.status),e.style.visibility="hidden"},k.ontimeout=function(){d.message="The request timeout!",d.error.call(d,k,k.status),e.style.visibility="hidden"},k.send(f)}},b.submit=function(a){if(a&&"string"==typeof a.action){var c=a.getAttribute("data-ajax");"false"==c||0==this.captureForm&&"true"!=c||a.addEventListener("submit",function(a){var c=this.getAttribute("data-preventdefault"),d=b.getFunction(c);return"function"==typeof d&&1==d(this)?(a.preventDefault(),!1):(b.ajax(this),a.preventDefault(),void 0)})}},b.isBack=function(a,c){var d=-1,f=-1;return 1==history.tempBack?f=0:e.call(document.querySelectorAll("."+b.classPage)).forEach(function(b,e){b==a?d=e:b==c&&(f=e)}),history.tempBack=null,f>d},b.jsonHandle=function(){return'<p style="text-align:center;">Dear master, if you see me, show that JSON parsing function is undefined!</p>'},b.init=function(){var c,d,e,g;return 1==h?"Don't repeat initialization!":(c=location.hash.replace("#&","#"),d=null,""==c||"#"==c?this.transition(document.querySelector("."+this.classPage)):1==f.test(c)&&(d=document.querySelector(c))&&d.classList.contains(this.classPage)?this.transition(d):this.ajax({url:c.replace("#",""),dataType:"unknown",error:function(){d=document.querySelector("."+b.classPage),b.transition(d)}}),e="click",g=a.$||a.jQuery||a.Zepto,g&&g.fn&&g.fn.tap&&(e="tap"),1==this.captureLink&&(document.addEventListener(e,this.handleTapEvent),"tap"==e&&document.addEventListener("click",function(a){var d,e,c=a.target;c&&("a"==c.tagName.toLowerCase()||(c=c.getParentElementByTag("a")))&&(d=c.getAttribute("data-ajax"),e=c.href,"external"==c.getAttribute("data-rel")||"false"==d||e.split("/")[0]!==location.href.split("/")[0]&&"true"!=d||0==b.captureLink&&"true"!=d||a.preventDefault())})),h=!0,void 0)},b.handleTapEvent=function(a){var f,g,h,j,k,l,m,n,o,p,q,r,d=a.target||a.touches[0],e=d.href;if(e&&0!=/a/i.test(d.tagName)||!(d=d.getParentElementByTag("a"))||(e=d.href),f=document.querySelector(".in."+b.classPage),null!=f&&d){if(g=d.getAttribute("data-preventdefault")||i(d.getAttribute("data-params")||"").preventdefault,h=b.getFunction(g),"function"==typeof h&&1==h(d))return a.preventDefault(),!1;if(j=d.getElementsByClassName(b.classMask)[0],j&&"hidden"!=j.style.visibility)return a.preventDefault(),!1;if(k=1==b.captureLink,l=d.getAttribute("data-rel"),m=!1,"back"==l&&(m=!0),n="external"==l,e){if(""===d.getAttribute("href").replace(/#/g,""))return a.preventDefault(),void 0;if(/^javascript/.test(e)){if(0==m)return}else if(n=n||e.split("/")[0]!==location.href.split("/")[0],(1==n||0==k)&&"true"!=d.getAttribute("data-ajax"))return;1==/^#/.test(d.getAttribute("href"))?(o=e.split("#")[1],p=o&&document.getElementById(o),0==m&&"auto"==l&&(m=b.isBack(p,f)),p&&b.transition(p,f,m,{target:d}),a.preventDefault()):/^javascript/.test(e)?(history.tempBack=!0,history.back()):"false"!=d.getAttribute("data-ajax")&&(q=b.getCleanUrl(d),r=d.getAttribute("data-reload"),d.getAttribute("href"),null!=r&&"false"!=r||!c[q]?b.ajax(d):(0==m&&"auto"==l&&(m=b.isBack(c[q],f)),b.transition(c[q],f,m,{target:d,id:q})),a.preventDefault())}}},Element.prototype.getParentElementByTag=function(a){var b,c,d;return a?(b=null,c=this,d=function(){if(c=c.parentElement,!c)return null;var e=c.tagName.toLowerCase();e===a?b=c:"body"==e?b=null:d()},d(),b):null},i=function(a){var b={};return"string"==typeof a&&a.split("&").forEach(function(a){var c=a.split("=");c.length>1&&(b[c[0]]=a.replace(c[0]+"=",""))}),b},window.addEventListener("DOMContentLoaded",function(){0==h&&b.init()}),window.addEventListener("popstate",function(){var e,a=location.hash.replace("#&","").replace("#",""),d=null;if(""==a){if(d=document.querySelector("."+b.classPage),d.id)return}else d=c[a];if(!d){if(0==f.test(a))return b.ajax({url:a,dataType:"unknown"}),void 0;d=document.querySelector("#"+a)}e=document.querySelector(".in."+b.classPage),d&&d==e||0==b.pushStateEnabled||d&&b.transition(d,e,b.isBack(d,e),{history:!1,remove:!1})}),b)});